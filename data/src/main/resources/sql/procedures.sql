-- Добавление новой записи в таблицу USERS
CREATE OR REPLACE PROCEDURE ADD_USER(
  LOGIN VARCHAR2, 
  HASH_PASSWD VARCHAR2, 
  ROLE VARCHAR2, 
  ID_PEOPLE INTEGER,
  IDENT OUT INTEGER
) IS 
PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN 
	INSERT INTO USERS(LOGIN, HASH_PASSWD, ROLE, ID_PEOPLE)
	VALUES (LOGIN, HASH_PASSWD, ROLE, ID_PEOPLE)
  RETURNING ID INTO IDENT;
  COMMIT;
EXCEPTION
	WHEN OTHERS THEN IDENT := -1;
	ROLLBACK;
END;
//

-- добавление новой записи в таблицу PEOPLES
CREATE OR REPLACE PROCEDURE ADD_PEOPLE(
	FIRST_NAME VARCHAR2,
	MIDDLE_NAME VARCHAR2,
	LAST_NAME VARCHAR2,
	DATE_BIRTH DATE,
	SEX VARCHAR2,
	ID_CONTACT INTEGER,
	IDENT OUT INTEGER
) IS
PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
	INSERT INTO PEOPLES(FIRST_NAME, MIDDLE_NAME, LAST_NAME, DATE_BIRTH, SEX, ID_CONTACT)
	VALUES (FIRST_NAME, MIDDLE_NAME, LAST_NAME, DATE_BIRTH, SEX, ID_CONTACT)
	RETURNING ID INTO IDENT;
	COMMIT;
EXCEPTION
	WHEN OTHERS THEN IDENT := -1;
	ROLLBACK;
END;
//

CREATE OR REPLACE PROCEDURE ADD_LOCATION (
	COUNTRY VARCHAR2,
	CITY VARCHAR2,
	DESCRIPTION VARCHAR2,
	NEW_ID OUT INTEGER
) IS
PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
	INSERT INTO LOCATIONS(COUNTRY, CITY, DESCRIPTION)
	VALUES (COUNTRY, CITY, DESCRIPTION)
	RETURNING ID INTO NEW_ID;
	COMMIT;
EXCEPTION
	WHEN OTHERS THEN NEW_ID := -1;
	ROLLBACK;
END;
//

CREATE OR REPLACE PROCEDURE ADD_CONTACT(
	PHONE VARCHAR2,
	EMAIL VARCHAR2,
	ID_LOCATION INTEGER,
	IDENT OUT INTEGER
) IS
PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
	INSERT INTO CONTACTS(PHONE, EMAIL, ID_LOCATION)
	VALUES (PHONE, EMAIL, ID_LOCATION)
	RETURNING ID INTO IDENT;
	COMMIT;
EXCEPTION
	WHEN OTHERS THEN IDENT := -1;
	ROLLBACK;
END;
//

-- Регистрация нового пользователя
CREATE OR REPLACE PROCEDURE REGISTER_USER (
	LOGIN VARCHAR2,
	HASH_PASSWD VARCHAR2,
	FIRST_NAME VARCHAR2,
	MIDDLE_NAME VARCHAR2,
	LAST_NAME VARCHAR2,
	DATE_BIRTH DATE,
	SEX VARCHAR2,
	PHONE VARCHAR2,
	EMAIL VARCHAR2,
	COUNTRY VARCHAR2,
	CITY VARCHAR2,
	DESCRIPTION VARCHAR2,
	ID_USER OUT INTEGER
) IS
PRAGMA AUTONOMOUS_TRANSACTION;
	IDENT INTEGER;
	ERR_LOCATION EXCEPTION;
	ERR_CONTACT EXCEPTION;
	ERR_PEOPLE EXCEPTION;
  	ERR_USER EXCEPTION;
BEGIN
	ADD_LOCATION(COUNTRY, CITY, DESCRIPTION, IDENT);
	IF IDENT = -1 THEN
		RAISE ERR_LOCATION;
	END IF;
	
	ADD_CONTACT(PHONE, EMAIL, IDENT, IDENT);
	IF IDENT = -1 THEN
		RAISE ERR_CONTACT;
	END IF;
	
	ADD_PEOPLE(FIRST_NAME, MIDDLE_NAME, LAST_NAME, DATE_BIRTH, SEX, IDENT, IDENT);
	IF IDENT = -1 THEN 
		RAISE ERR_PEOPLE;
	END IF;
	
	ADD_USER(LOGIN, HASH_PASSWD, 'USER', IDENT, ID_USER);
	IF ID_USER = -1 THEN
		RAISE ERR_USER;
	END IF;
EXCEPTION
	WHEN ERR_LOCATION THEN RAISE_APPLICATION_ERROR(-20001, 'Ошибка при добавлении локации');
	WHEN ERR_CONTACT THEN RAISE_APPLICATION_ERROR(-20002, 'Ошибка при добавлении контакта');
	WHEN ERR_PEOPLE THEN RAISE_APPLICATION_ERROR(-20003, 'Ошибка при добавлении человека');
	WHEN ERR_USER THEN RAISE_APPLICATION_ERROR(-20004, 'Ошибка при добавлении пользователя');
	ROLLBACK;
END;
//