CREATE OR REPLACE
FUNCTION COUNT_ROOM_PRICE(ID_ROOM IN INTEGER, CURRENCY_DESC VARCHAR2)
RETURN FLOAT IS
  PRICE FLOAT := 0;
  RATE_RESULT FLOAT := 0;
BEGIN
  BEGIN
    SELECT CURRENCY.RATE INTO RATE_RESULT
    FROM CURRENCY
    WHERE DESCRIPTION = CURRENCY_DESC;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20000, 'Неизвестный тип валюты');
  END;

  SELECT (FOOD.PRICE * CUR_FOOD.RATE + PLACEMENT.PRICE * CUR_PLACEMENT.RATE)
  INTO PRICE
  FROM ROOMS
  JOIN FOOD ON FOOD.ID = ROOMS.ID_FOOD
  JOIN PLACEMENT ON PLACEMENT.ID = ROOMS.ID_PLACEMENT
  JOIN CURRENCY CUR_FOOD ON CUR_FOOD.ID = FOOD.ID_CURRENCY
  JOIN CURRENCY CUR_PLACEMENT ON CUR_PLACEMENT.ID = PLACEMENT.ID_CURRENCY
  WHERE ROOMS.ID = ID_ROOM;
  IF PRICE IS NULL THEN 
    PRICE := 0; 
  END IF;
  RETURN PRICE / RATE_RESULT;
END COUNT_ROOM_PRICE;
/

CREATE OR REPLACE
FUNCTION COUNT_TOUR_PRICE(TOUR_ID IN INTEGER, CURRENCY_DESC VARCHAR2)
RETURN FLOAT IS
  RATE_RESULT FLOAT DEFAULT 0;
  PRICE FLOAT DEFAULT 0;
  PRICE_HOTEL FLOAT DEFAULT 0;
BEGIN
  BEGIN
    SELECT RATE INTO RATE_RESULT FROM CURRENCY
    WHERE DESCRIPTION = CURRENCY_DESC;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20000, 'Неизвестный тип валюты');
  END;

  SELECT SUM(RP) INTO PRICE_HOTEL FROM (
    SELECT COUNT_ROOM_PRICE(ROOMS.ID, CURRENCY_DESC) RP
    FROM ROOMS
    JOIN HOTELS ON HOTELS.ID_TOUR = TOUR_ID
    WHERE ROOMS.ID_HOTEL = HOTELS.ID);
  SELECT SUM(FP) INTO PRICE FROM (
    SELECT (FLIGHTS.PRICE * CURRENCY.RATE) FP FROM FLIGHTS
    JOIN CURRENCY ON CURRENCY.ID = FLIGHTS.ID_CURRENCY
    WHERE FLIGHTS.ID_TOUR = TOUR_ID);
  IF PRICE_HOTEL IS NULL THEN 
    PRICE_HOTEL := 0; 
  END IF;
  IF PRICE IS NULL THEN 
    PRICE := 0; 
  END IF;
  PRICE := PRICE / RATE_RESULT + PRICE_HOTEL;
  RETURN (PRICE * 1.30);
END;
/
